name: ci

on:
  push:
  pull_request:

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Start stack
        run: |
          docker compose \
            -f infra/compose/iteration-1-minio.compose.yml \
            -f infra/compose/iteration-5-rmq-cluster.compose.yml \
            -f infra/compose/iteration-4-db.compose.yml \
            -f infra/compose/iteration-2-clients.compose.yml \
            up -d --build --remove-orphans

      - name: Wait for infra to become healthy
        run: |
          set -euo pipefail
          files="-f infra/compose/iteration-1-minio.compose.yml \
                 -f infra/compose/iteration-5-rmq-cluster.compose.yml \
                 -f infra/compose/iteration-4-db.compose.yml"

          # Wait up to ~180s for core infra to be healthy
          for i in {1..90}; do
            ok=1
            for svc in minio postgres haproxy rmq-1 rmq-2 rmq-3; do
              status="$(docker compose $files ps --format json 2>/dev/null | jq -r ".[] | select(.Service==\"$svc\") | .Health")"
              if [ "$status" != "healthy" ] && [ "$svc" != "postgres" ]; then
                ok=0
              fi
              # postgres often shows empty Health in compose json; treat "running" as OK
              if [ "$svc" = "postgres" ]; then
                state="$(docker compose $files ps --format json 2>/dev/null | jq -r ".[] | select(.Service==\"$svc\") | .State")"
                if [ "$state" != "running" ]; then ok=0; fi
              fi
            done

            if [ "$ok" = "1" ]; then
              echo "Infra is healthy"
              exit 0
            fi

            echo "Waiting for infra... ($i/90)"
            sleep 2
          done

          echo "Infra did not become healthy in time"
          docker compose $files ps
          exit 1

      - name: Run integration tests
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          pytest -v tests/integration

      - name: Dump logs on failure
        if: failure()
        run: |
          docker compose \
            -f infra/compose/iteration-1-minio.compose.yml \
            -f infra/compose/iteration-5-rmq-cluster.compose.yml \
            -f infra/compose/iteration-4-db.compose.yml \
            -f infra/compose/iteration-2-clients.compose.yml \
            logs --no-color

      - name: Tear down
        if: always()
        run: |
          docker compose \
            -f infra/compose/iteration-1-minio.compose.yml \
            -f infra/compose/iteration-5-rmq-cluster.compose.yml \
            -f infra/compose/iteration-4-db.compose.yml \
            -f infra/compose/iteration-2-clients.compose.yml \
            down -v --remove-orphans
